# Current Task: Compiler Rewrite

**Status:** In Progress
**Date:** 2025-12-07
**Branch:** compiler-rewrite

---

## Current State Summary

**Parser:** 100% Complete
**Semantic Analysis:** 100% Complete
**Test Status:** 2411 library tests passing

---

## Task 26: Compiler Rewrite - 2-Pass Architecture

See `/claude/tasks/26_compiler_rewrite.md` for full details.

### Completed Tasks

| # | Task | Description | Status |
|---|------|-------------|--------|
| 1 | Workspace Setup | Create workspace Cargo.toml, crate skeleton, lib.rs with re-exports | ✅ Complete |
| 2 | Types: TypeHash | Move TypeHash to compiler crate, add Display, make Copy | ✅ Complete |
| 3 | Types: DataType | Move DataType, make Copy, add Display, RefModifier | ✅ Complete |
| 4 | Types: TypeDef + FunctionDef | Create clean TypeDef enum and FunctionDef struct | ✅ Complete |

### Task 26.4 Summary (Just Completed)

**TypeDef enum** - Full implementation with 6 variants:
- `Primitive`: Built-in types (void, bool, int8..int64, uint8..uint64, float, double)
- `Class`: User classes, templates, template instances
- `Interface`: Interface definitions with method signatures
- `Enum`: Enumeration types with name-value pairs
- `Funcdef`: Function pointer types
- `TemplateParam`: Template parameter placeholders (T, K, V)

**Supporting types for TypeDef:**
- `PrimitiveType`: Enum for primitive type kinds with name() and type_hash()
- `Visibility`: Public/Protected/Private with Display
- `TypeKind`: Value/Reference/ScriptObject for memory semantics
- `ReferenceKind`: Standard/GarbageCollected/NoCount
- `FieldDef`: Class field with name, type, visibility
- `MethodSignature`: Interface method signature
- `PropertyAccessors`: Getter/setter function hashes
- `OperatorBehavior`: All 60+ operator overload types

**FunctionDef struct** - Complete function definition:
- `func_hash`, `name`, `namespace`, `params`, `return_type`
- `object_type`, `traits`, `is_native`, `visibility`
- **NO `signature_filled`** - 2-pass means always complete
- Helper methods: qualified_name(), is_method(), is_constructor(), etc.

**Supporting types for FunctionDef:**
- `Param`: Parameter with name, type, has_default flag (no lifetime)
- `FunctionTraits`: is_constructor, is_destructor, is_virtual, is_const, etc.
- `AutoGeneratedMethod`: DefaultConstructor/CopyConstructor/OpAssign

**Test results:**
- 81 unit tests passing in compiler crate
- 17 doctests passing in compiler crate
- All 2411 main crate tests still passing

### Next Task

**Task 26.5: Types: ExprInfo** - Create ExprInfo (renamed from ExprContext)

---

## Quick Reference

**Task File:** `/claude/tasks/26_compiler_rewrite.md`
**Decisions Log:** `/claude/decisions.md`

---

## Architecture Overview

### New (in `crates/angelscript-compiler/`):
```
Pass 1 (registration.rs):  Register types → Register functions with COMPLETE signatures
Pass 2 (compilation/):     Type check function bodies + generate bytecode
```

### Key Benefits
- 2 passes instead of 3 - Faster compilation
- No format!() overhead - Proper type resolution
- Better testability - Independent components
- DataType as Copy - Eliminates 175+ clone() calls
- ~8,000 lines deleted after migration
